# 复盘 (Fupan) 应用业务逻辑详述 (a11.md)

本文档旨在详细解释“复盘”应用的完整业务逻辑流，从计划建立到最终的周报统计，帮助开发者和用户理解系统背后的设计哲学与计算规则。

---

## 1. 核心哲学：先计划，再交易

“复盘”应用的核心设计理念是**强制纪律**。它要求交易者在进入市场前必须有明确的计划，并在交易过程中客观记录偏离，最后通过系统化的评估来识别并改进情绪化行为。

---

## 2. 阶段一：建立计划 (Create Plan)

所有交易的起点必须是一个“计划”。

- **初始状态**：`draft` (草稿)。
- **核心输入**：
  - **买入逻辑**：选择买入原因类型（趋势、区间、政策等）并提供简短摘要。
  - **目标区间**：设定预期的卖出目标高位和低位。
  - **止损逻辑**：设定技术止损位、时间止损天数或最大回撤百分比。
  - **预算价**：预期的买入价格。
- **逻辑锁定**：在草稿阶段，用户可以自由修改所有字段。一旦进入下一阶段，核心逻辑将被锁定，后续修改将记录为“修订记录”。

---

## 3. 阶段二：建仓与武装 (Arming)

当用户实际买入股票后，计划需要被“武装”。

- **状态转换**：`draft` → `armed` (已建仓/武装)。
- **操作**：用户录入“实际入场价”和“入场驱动因素”。
- **自动触发**：如果在“添加事件”中记录了“买入追高”事件并填写了价格，系统会自动将计划状态从 `draft` 变更为 `armed`。
- **意义**：此时计划正式生效，系统开始监控执行与计划之间的偏差。

---

## 4. 阶段三：过程记录与结构化事件 (Events)

在持仓过程中，任何影响计划成立的事实证据都应被记录。

- **结构化事件阶段 (`event_stage`)**：
  1.  **买入追高 (E-TNR)**：实际买入价高于预算价。
  2.  **低位未买 (E-LDC)**：价格到达买入区间但未执行。
  3.  **到位不卖 (TNR)**：价格到达目标区间但未执行卖出。
  4.  **止损拖延 (LDC)**：价格触及止损线但未执行止损。
  5.  **提前卖出 (EPC)**：未达目标或未触发止损即提前离场。
- **行为驱动 (`behavior_driver`)**：记录当时的心理状态（如 FOMO、恐惧回撤、贪婪犹豫等）。
- **计划失效开关 (`triggered_exit`)**：如果某个事件（如基本面恶化）导致原计划逻辑不再成立，勾选此项。这在后续统计中非常关键，因为它能将“合理的逻辑变更”与“违规的纪律偏离”区分开。

---

## 4. 阶段四：平仓关闭与系统判定 (Settlement)

交易结束时，系统会进行客观审计。

- **状态转换**：`armed`/`holding` → `closed` (已关闭)。
- **系统判定 (`judgement`)**：
  - **一致执行 (`follow_plan`)**：卖出原因与计划相符。
  - **情绪覆盖 (`emotion_override`)**：卖出原因偏离计划。
- **EPC (Early Profit Cut) 计算**：
  - 如果用户提前卖出，系统会要求录入“观察期内最优价”。
  - `EPC 成本 = (观察期最优价 - 实际卖出价) / 实际卖出价`。
  - **豁免逻辑**：如果卖出是由标记为 `triggered_exit` 的事件触发的，则不计入 EPC 违规统计。

---

## 5. 阶段五：自我评估 (Self-Assessment)

平仓后，用户必须完成 13 维度的量化自评。

- **维度**：涵盖买入前（逻辑、心理）、持仓中（波动耐受）、卖出执行（果断性）及盘后总结。
- **分值**：1-3 分，每个分值对应具体的行为描述。
- **目的**：通过主观评估补充系统的客观数据，形成完整的复盘画像。

---

## 6. 阶段六：周报统计与核心指标 (Weekly Report)

每周系统会汇总所有交易数据，生成纪律审计报告。

### 核心指标说明：

1.  **PCS (Plan Consistency Score - 计划一致性)**：
    - **满分 100 分**。
    - **扣分项**：缺失核心字段（预算价、目标、止损）、发生 E-TNR/LDC/TNR/EPC 偏离、计划失效后未及时平仓。
2.  **E-TNR (买入追高)**：
    - 统计实际建仓价超过预算价 1% 以上的交易。
    - 偏离幅度越大，分值越高。
3.  **E-LDC (低位未买)**：
    - 统计记录的“低位未执行”事件。
4.  **TNR (到位不卖)**：
    - 统计价格到达目标（通过 `verify` 类型事件确认）但未卖出的情况。
5.  **LDC (止损拖延)**：
    - 统计实际卖出价低于止损价 1% 以上的交易。
6.  **EPC (提前卖出)**：
    - 统计非计划失效导致的提前离场行为。

---

## 总结

“复盘”应用通过**状态机**（Draft -> Armed -> Closed）和**结构化事件**，将感性的交易过程转化为理性的数据。它不关心你赚了多少钱，只关心你是否“说到做到”。
